<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Jury</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    h1 { margin-bottom: 20px; }
    button {
      margin: 10px;
      font-size: 18px;
      padding: 10px 30px;
    }
    input {
      padding: 6px;
      font-size: 16px;
      width: 180px;
      margin: 4px;
    }
    .chrono {
      font-size: 36px;
      font-weight: bold;
      margin: 10px;
      color: #222;
    }
  </style>
</head>
<body>
  <h1>üéõÔ∏è Contr√¥le Jury</h1>
  <div>
    <input id="nomA" placeholder="Nom √âquipe A" oninput="majNom('A', this.value)" />
    <input id="nomB" placeholder="Nom √âquipe B" oninput="majNom('B', this.value)" />
  </div>
  </div>

  <div>
    <input id="logoA" placeholder="URL Logo √âquipe A" oninput="majLogo('A', this.value)" />
    <input id="logoB" placeholder="URL Logo √âquipe B" oninput="majLogo('B', this.value)" />
  </div>
  <br>
<div class="chrono" id="chronoA">A - 00:00.000</div>
  <button onclick="start('A')">‚ñ∂Ô∏è D√©marrer A</button>
  <button onclick="stop('A')">‚èπÔ∏è Stop A</button><br>
  <div class="chrono" id="chronoB">B - 00:00.000</div>
  <button onclick="start('B')">‚ñ∂Ô∏è D√©marrer B</button>
  <button onclick="stop('B')">‚èπÔ∏è Stop B</button><br><br>
  <button onclick="start('A'); start('B');">‚ñ∂Ô∏è D√©marrer les 2</button><br><br>
  <button onclick="resetAll()">üîÅ Reset</button><br><br>
  <button onclick="enregistrerCourse()">üíæ Enregistrer la course</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBUXyiC63cD3Y1zGy9UaPJ5yMEaDPvC5PE",
      authDomain: "chrono-equipe-v2.firebaseapp.com",
      databaseURL: "https://chrono-equipe-v2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "chrono-equipe-v2",
      storageBucket: "chrono-equipe-v2.firebasestorage.app",
      messagingSenderId: "962671917095",
      appId: "1:962671917095:web:c6914f49cead3743a93602"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function start(equipe) {
      db.ref("chronos/" + equipe + "/startedAt").set(Date.now());
      db.ref("chronos/" + equipe + "/stoppedAt").remove();
    }

    function stop(equipe) {
  const now = Date.now();
  db.ref('chronos/' + equipe + '/stoppedAt').set(now);
}
      db.ref("chronos/" + equipe + "/stoppedAt").set(Date.now());
    }

    function resetAll() {
      db.ref("chronos").remove();
      db.ref("noms").remove();
    }

    function majLogo(equipe, url) {
  db.ref('logos/' + equipe).set(url);
}

function majNom(equipe, nom) {
      db.ref("noms/" + equipe).set(nom);
    }

    function enregistrerCourse() {
      Promise.all([
        db.ref("noms").once("value"),
        db.ref("chronos").once("value")
      ]).then(([nomsSnap, chronoSnap]) => {
        const noms = nomsSnap.val() || {};
        const chronos = chronoSnap.val() || {};
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, "-");
        const data = {
          timestamp: now.toLocaleString(),
          A: {
            nom: noms.A || "√âquipe A",
            start: chronos.A?.startedAt || null,
            stop: chronos.A?.stoppedAt || null,
            duree: chronos.A?.startedAt && chronos.A?.stoppedAt ? chronos.A.stoppedAt - chronos.A.startedAt : null
          },
          B: {
            nom: noms.B || "√âquipe B",
            start: chronos.B?.startedAt || null,
            stop: chronos.B?.stoppedAt || null,
            duree: chronos.B?.startedAt && chronos.B?.stoppedAt ? chronos.B.stoppedAt - chronos.B.startedAt : null
          }
        };
        db.ref("historique/" + timestamp).set(data);
        alert("Course enregistr√©e !");
      });
    }

    function format(ms) {
      const m = String(Math.floor(ms / 60000)).padStart(2, '0');
      const s = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
      const msr = String(ms % 1000).padStart(3, '0');
      return `${m}:${s}.${msr}`;
    }

    function afficherChrono(equipe) {
      const el = document.getElementById("chrono" + equipe);
      db.ref("chronos/" + equipe).on("value", snap => {
        const val = snap.val();
        if (!val?.startedAt) {
          el.textContent = `${equipe} - 00:00.000`;
          return;
        }
        const start = val.startedAt;
        const stop = val.stoppedAt;
        if (stop) {
          el.textContent = `${equipe} - ` + format(stop - start);
        } else {
          clearInterval(window["timer_" + equipe]);
          window["timer_" + equipe] = setInterval(() => {
            el.textContent = `${equipe} - ` + format(Date.now() - start);
          }, 100);
        }
      });
    }

    afficherChrono("A");
    afficherChrono("B");
  </script>
</body>
</html>
